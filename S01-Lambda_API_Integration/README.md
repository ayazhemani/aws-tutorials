# Getting started with Amazon Web Services
_by Ayaz Hemani_

> **This workshop is meant to provide beginners with basic AWS services and E2E application development using Lambda, API Gateway, and S3 services.**  
> **This tutorial pre-supposes basic coding knowledge. Python is used; however, code snippets are provided for those with limited Python knowledge.**

## Lambdas - Python 2.7

### Task 01 - Hello World

1. Create a Hello World Lambda Function
    * Select default: _Author from scratch_
    * Name: _helloWorld_
    * Runtime: _Python 2.7_
    * Role: _Create a custom Role_
        * IAM Role: _Create a new IAM Role_
        * Role Name: _lamba_basic_execution_
        * Click **Allow** to proceed
    * Note: Role field should now change to _Choose an existing role_
    * Existing role: _lamba\_basic\_execution_
2. Explore the interface
    * Designer shows a graphical I/O interface for the lamda function. Notice how various triggers can be added to call the lambda. By default, the IAM role generated has access to a logging service _Amazon CloudWatch Logs_
3. Let's dive into the Function Code
    * Click the _helloWorld_ lamda function
    * Notice the python 2.7 method that is generated by default. A single return statement is present to return a _"Hello from lambda"_ string
    * Let's change the default return string to return _"Hello World!"_
    * Click the orange **Save** button to reflect these changes
    * Click the **Test** button
4. Create a Test
    * Create a new test event
    * Event template: _Hello World_
    * Event name: _testHelloWorldDefault_
    * Click the **Create** button
5. Run the Lambda against a test
    * Ensure the _testHelloWorldDefault_ test is selected and click the **Test** button
    * Notice the two sections where Execution results are shown
        * An output of the log is stored in CloudWatch and can be found in green at the top of your screen.
        * The output is also available directly below the code window
    * Please note some billing considerations here as well. Execution space-time complexity is not always what is billed; rather, billing is based on the lambda procurements that AWS makes by default.
    * You should see a response from the lambda as _"Hello World!"_
6. Exploring the Hello World Function
    * _Event_ Parameter
        * Return the _event_ parameter
        * Click **Save** and test against the _testHelloWorldDefault_ test
        * Notice the response change to the dictionary provided in the test
    * _Context_ Parameter
        * The context parameter provides context regarding the lambda execution object. Attributes such as function name, version, memory limit, etc can be helpful especially during debugging. Notably, the context parameter also contains a method called _get\_remaining\_time\_in\_millis()_ until AWS Lambda terminates the function.
7.  Modify Hello World to Greet Patrons
    * Modify the _helloWorld_ lambda function
        * Look for element _patron_ in the _event_ dictionary
    * Run the test against _testHelloWorldDefault_
        * Notice the greeting _Hello World!_
8. Create a new test called testGreetPatron
    * Ensure the dictionary contains a key, _patron_ and a value of _"Your Name"_

### Task 02 - Custom Eight Ball

1. Create the customEightBallRandom lambda function to randomly return a string quote from a list. Note that you will need to import the random module.
2. Create a test called testCustomEightBallRandom to test the above functionality.
3. Create a copy of the lambda function and name it customEightBallCalculated. Modify the lambda function to accept a pre-calculated random number to force the value of the returned quote.
4. Create a test called testCustomEightBallCalculated to test the above functionality.

## API Gateway
### Task 01 - Create the _customEightBallAPI_ API
1. Create a New API and name it _"customEightBallAPI"_
2. Create a default resource for your API
    * Under **Actions** select _Create Resource_
    * Set **Resource Name** to _customEightBall_
    * Check **Enable API Gateway CORS**
    * Click **Create Resource**
3. Create a POST Method for your API
    * Under **Actions** select _Create Method_
    * Select _POST_ and click the check box to confirm
    * Select the **Integration Type** as _Lambda Function_
    * Enable **Lambda Proxy integration**
    * In the field **Lambda Function**, type _customEightBall_
    * Select **Save** then **OK** to provide permissions to the API Gateway
4. Deploy your API
    * Under **Actions** select _Deploy API_
    * Under **Deployment Stage** select _[New Stage]_
    * Provide a **Stage Name** of _version1_
    * Click **Deploy**.

    > After the API is successfully deployed, you see the API's base URL (the default host name plus the stage name) displayed as Invoke URL at the top of the Stage Editor.  
    > The general pattern of this base URL is https://api-id.region.amazonaws.com/stageName.

5. Test your API
    * Open a terminal window on a computer connected to the internet. Run the following:

        >curl -X POST https://_your\_API\_ID_.execute-api._your\_region_.amazonaws.com/_your\_stage\_name_/_your\_resource\_name_ 

        >curl -X POST https://x8ezjy4ene.execute-api.us-east-2.amazonaws.com/version1/customeightball

    * Alternatively, this URL can be found by navigating to your stage, clicking on the POST method, and copying the invoke URL
    * The result should be a random quote generated by your lambda function

## Generating a Front-End Webpage
### Task 01 - Display the Random Eight Ball output
  * Create a new .HTML file locally called _random8BallGenerator.html_

```html
<html>
<head>
    <title>Random 8-Ball Generator</title>
</head>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    console.log('Hello World')
    $('#Submit').click(function() {
        $('#quote').text("");
        let request = new XMLHttpRequest();
        let url = 'https://x8ezjy4ene.execute-api.us-east-2.amazonaws.com/version1/customeightball';
        request.onreadystatechange = function() {
            if (this.readyState === 4 && this.status === 200) {
                let response = JSON.parse(this.responseText);
                console.log(response)
                $('#quote').text(response.result);
            }
        }
        request.open("POST", url, true);
        request.setRequestHeader("x-api-key", "ENTER_YOUR_API_HERE");
        request.send({"random_float": $('#random_float').val()});
    });
});
</script>
<form>
    Random Float: <input type="text" id="random_float"><br>
</form>

<button id="Submit">Submit</button>
<p id="quote"></p>

</body>
</html>
```
* When you open this in an HTML browser and click **Submit** to inititate the POST, you will notice the following error message:

 > Failed to load https://x8ezjy4ene.execute-api.us-east-2.amazonaws.com/version1/customeightball:  
 > No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'null' is therefore not allowed access. The response had HTTP status code 400.

* Now we must change the lambda response to include the requisite headers for the HTTP response.

###Task 02 - Modify the Lambda for HTTP Responses

1. Include HTTP headers in your lambda. Change your _return_ statement to return the full HTTP response:

```python
import random
import json

def lambda_handler(event, context):
    if event.get("calculated_float"):
        rand_float = event["calculated_float"]
    else:
        rand_float = random.random()
    millenial_quotes = [
        "You're a wizard",
        "He who controls the keyboard controls the universe",
        "Never put twinkies on your pizza"
        ]
    quote_index = int(rand_float * len(millenial_quotes))
    result = millenial_quotes[quote_index]

    headers = {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": '*',
        "Access-Control-Allow-Credentials": 'true'
    }
    body = {
        "result": result
    }
    response = {
        "statusCode": 200,
        "headers": headers,
        "body": json.dumps(body)
    }
    return response

```
2. Test your lambda against _testHelloWorldDefault_ and verify that a random quote is returned. An example is as follows:
```json
Response:
{
  "body": {"result": "Never put twinkies on your pizza"},
  "headers": {
    "Access-Control-Allow-Origin": "*",
    "Content-Type": "application/json",
    "Access-Control-Allow-Credentials": "true"
  },
  "statusCode": 200
}
```
3. Enable CORS for your API Gateway Resource
    * Select the _/customeightball_ resource, click the **Actions** button, and select **Enable CORS**
    * Proceed with defaults and click **Enable CORS and replace existing CORS headers**
    * Redeploy your API to _version1_
4. Reload the _random8BallGenerator.html_ file and click **Submit**. You should now see a quote displayed.





