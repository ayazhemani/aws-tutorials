# Getting started with Amazon Web Services
_by Ayaz Hemani_

> **This workshop is meant to provide beginners with basic AWS services and E2E application development using Lambda, API Gateway, and S3 services.**  
> **This tutorial pre-supposes basic coding knowledge. Python is used; however, code snippets are provided for those with limited Python knowledge.**

> The cURL command-line utility is used for this workshop. Please install it and verify that it works.

## Lambdas - Python 2.7

### Task 01 - Hello World

1. Create a Hello World Lambda Function
    * Select default: _Author from scratch_
    * Name: _helloWorld_
    * Runtime: _Python 2.7_
    * Role: _Create a custom Role_
        * IAM Role: _Create a new IAM Role_
        * Role Name: _lamba\_basic\_execution_
        * Click **Allow** to proceed
    * Note: The Role field should now be blank and **Existing role** populated with  _lamba\_basic\_execution_
    * Click **Create function**
2. Explore the interface
    * Designer shows a graphical I/O interface for the lamda function. Notice how various triggers can be added to call the lambda. By default, the IAM role generated has access to a logging service _Amazon CloudWatch Logs_
3. Let's dive into the Function Code  
    * Notice the python 2.7 method that is generated by default. A single return statement is present to return a _"Hello from Lambda"_ string
    * Let's change the default return string to return _"Hello World!"_
    * Click the orange **Save** button to reflect these changes
    * Click the **Test** button
4. Create a Test
    * Create a new test event
    * Event template: _Hello World_
    * Event name: _testHello_
    * Click the **Create** button
5. Run the Lambda against a test
    * Ensure the _testHello_ test is selected and click the **Test** button
    * Notice the two sections where Execution results are shown
        * An output of the log is stored in CloudWatch and can be found in green at the top of your screen.
        * The output is also available directly below the code window
    * Please note some billing considerations here as well. Execution space-time complexity is not always what is billed; rather, billing is based on the lambda procurements that AWS makes by default.
    * You should see a response from the lambda as _"Hello World!"_
6. Exploring the Hello World Function
    * _Event_ Parameter
        * Return the _event_ parameter
        * Click **Save** and **Test** against _testHello_  
        * Notice the response change to the dictionary provided in the test
    * _Context_ Parameter
        * The context parameter provides context regarding the lambda execution object. Attributes such as function name, version, memory limit, etc can be helpful especially during debugging. Notably, the context parameter also contains a method called _get\_remaining\_time\_in\_millis()_ until AWS Lambda terminates the function.
7.  Modify Hello World to Greet Patrons
    * Modify the _helloWorld_ lambda function to greet a patron by name. If not found, greet the World.
        * Look for element _patron_ in the _event_ dictionary  
            ```python
            patron = event.get("patron")
            ```
    * Save and run the test against _testHello_
        * Notice the greeting _Hello World!_
8. Create a new test called testHelloPatron
    * Ensure the dictionary contains a key, _patron_ and a value of _"Your Name"_

### Task 02 - Custom Eight Ball

1. Create the _customEightBall_ lambda function to return a random string quote from a list. Note that you will need to import the random module. Use the existing role _lambda\_basic\_execution_
2. Create a test called testRandom to test the above functionality. Run it multiple times to ensure random results.
3. Modify the lambda function to accept a pre-calculated random floating-point number to force the value of the returned quote.  

  >  Note: Provided Code assumes input in the range of [0,1]  
4. Create a test called testCalculated to test the above functionality.

### Task 03 - Making your Lambda function API-Ready
Let's modify the Lambda for HTTP Responses

1. Include HTTP headers in your lambda. Change your _return_ statement to return the full HTTP response:

```python

    headers = {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Credentials": "true"
    }
    body = {
        "result": result
    }
    response = {
        "statusCode": 200,
        "headers": headers,
        "body": json.dumps(body)
    }
    return response

```
2. Test your lambda against _testRandom_ and _testCalculated_. An example is as follows:
```json
Response:
{
  "body": "{\"result\": \"You're a wizard\"}",
  "headers": {
    "Access-Control-Allow-Origin": "*",
    "Content-Type": "application/json",
    "Access-Control-Allow-Credentials": "true"
  },
  "statusCode": 200
}
```

## API Gateway
### Task 01 - Create the _customEightBallAPI_ API
1. Create a New API  
    * Set the **API Name** to _customEightBallAPI_  
    * Click **Create API**  
2. Create a resource for your API  
    * Under **Actions** select _Create Resource_  
    * Set **Resource Name** to _customEightBall_  
    * Check **Enable API Gateway CORS**  

        >  **Disclaimer**: Enabling CORS will allow any domain to hit your API endpoint  
        > **See CORS documentation for more information:**  
        > https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS  
        >  

    * Click **Create Resource**  

3. Create a POST Method for your API  
    * Under **Actions** select _Create Method_  
    * Select _POST_ and click the check box to confirm  
    * Select the **Integration Type** as _Lambda Function_  
    * In the field **Lambda Function**, type _customEightBall_  
    * Select **Save** then **OK** to provide permissions to the API Gateway  

4. Test the POST method
    * Click **Test** in the diagram under _Client_
    * Click **Test**
    * The response should be a random quote

5. Deploy your API
    * Under **Actions** select _Deploy API_
    * Under **Deployment Stage** select _[New Stage]_
    * Provide a **Stage Name** of _version1_
    * Click **Deploy**.

    > After the API is successfully deployed, you see the API's base URL (the default host name plus the stage name) displayed as **Invoke URL** at the top of the Stage Editor.  
    > The general pattern of this base URL is https://api-id.region.amazonaws.com/stageName.

6. Test your API
    * Open a terminal window on a computer connected to the internet. Run the following:

        >curl -X POST https://_your\_API\_ID_.execute-api._your\_region_.amazonaws.com/_your\_stage\_name_/_your\_resource\_name_ 

    * The result should be a random quote generated by your lambda function

## Generating a Front-End Webpage
### Task 01 - Display the Random Eight Ball output
  * Create a new .HTML file locally called _random8BallGenerator.html_

```html

<html>
<head>
    <title>Random 8-Ball Generator</title>
</head>
<body>
<script type="text/javascript">
$(document).ready(function() {
    $('#Submit').click(function() {
        $('#quote').text("");
        let request = new XMLHttpRequest();
        let url = 'https://your_API_ID.execute-api.your_region.amazonaws.com/your_stage_name/your_resource_name';
        request.onreadystatechange = function() {
            if (this.readyState === 4 && this.status === 200) {
                let response = JSON.parse(this.responseText);
                console.log(response);
                let response_body = JSON.parse(response.body);
                console.log(response_body);
                $('#quote').text(response_body.result);
            }
        }
        request.open("POST", url, true);
        request.send();
    });
});
</script>

<button id="Submit">Submit</button>
<p id="quote"></p>

</body>
</html>

```
* When you open this in an HTML browser and click **Submit** you should see a random quote generated

### Task 02 - Modify the Front-End for Custom Eight Ball Output
  * Create a new .HTML file locally called _custom8BallGenerator.html_
  

```js
$(document).ready(function() {
    $('#Submit').click(function() {
        $('#quote').text("");
        let request = new XMLHttpRequest();
        let url = 'https://your_API_ID.execute-api.your_region.amazonaws.com/your_stage_name/your_resource_name';
        let new_event = {"calculated_float": $("#calculated_float").val()};
        request.onreadystatechange = function() {
            if (this.readyState === 4 && this.status === 200) {
                let response = JSON.parse(this.responseText);
                console.log(response)
                let response_body = JSON.parse(response.body);
                console.log(response_body)
                $('#quote').text(response_body.result);
            }
        }

        request.open("POST", url, true);
        console.log(JSON.stringify(new_event))
        request.send(JSON.stringify(new_event));
    });
});
```

* Dont't forget to add the HTML form and input element!

```html
<form>
    Calculated Float: <input type="text" id="calculated_float">
</form>

```

* When you open this in an HTML browser and click **Submit** you should see a random quote generated  
* When you define an input in the range [0,1) you will see a predictable output

## Securing your API
### Modify the API Gateway to require an API Key
1. Require an API Key for the POST Method Request  
    * Navigate to your _Resources_ section and click on the **POST** method  
    * In the Method Execution diagram, click on **Method Request**
    * Change the **API Key Required** field to _true_ and select the checkmark
    * Re-deploy your API  
        * Click **Actions** and select **Deploy API**   
        * Select _version1_ under **Deployment Stage**  
        * Click **Deploy**  
2. Create a Usage Plan for the API  
    * On the left pane, select **Usage Plans** and click **Create**  
        * Provide the **Name** _publicS3_
        * Enable throttling with the **Rate** and **Burst** of _1 request per second_
        * Enable a **Quota** of _100 Requests per Day_
        * Click **Next**
    * Link your current API
        * Click **Add API Stage**
        * In the **API** dropdown select _customEightBallAPI_ 
        * In the **Stage** dropdown select _version1_ 
        * Select the checkmark to confirm and click **Next**
    * Create API Key
        * Click **Create API Key and add to Usage Plan**
        * Provide the name _publicS3_
        * Under **API Key** select _Auto Generate_  and select **Save**
        * Click **Done**  

### Modify the Front-End to be compliant with the API Key
1. Locate your API Key
    * Select **API Keys** in the left panel
    * Select **publicS3**
    * Click **Show** next to _API key_
    * Copy this API Key
2. Add the API Key to your API Call
    * Modify the front-end website javascript as follows:
```js
        request.open("POST", url, true);
        request.setRequestHeader("x-api-key", "API_KEY_HERE")
        request.send(JSON.stringify(new_event));
```
    * Reload the website and test

## Hosting your application with S3
### Create an S3 Bucket and upload your page
1. Navigate to services and type and select **S3**
2. Create an S3 bucket
    * Select **+ Create bucket**
    * Provide a _globally unique_ bucket name and select **Next**
    * Proceed with default configuration options. Click **Next**
    * Proceed with default permission options. Click **Next**
    * Review all settings. Click **Create bucket**
3. Upload your Page
    * Under **Bucket name**, click _on_ your bucket name
    * Click **Upload** and upload your secure HTML page
        * Click **Add Files** to navigate and upload your HTML file. Click **Next** to confirm the file(s)  
        * Under _Manage public permissions_ select **Grant public read access to this object(s)**. Click **Next**
        * Proceed with default property options. Click **Next**
        * Review all settings. Click **Upload**
4. Test your online site!
    * Find your HTML page in your bucket. Right click and select **Open**  
    * Test your luck with your Custom Eight Ball!

    > Note: Your S3 bucket uploads can also be accessed with the following:  
``` https://s3.amazonaws.com/<BUCKET_NAME>/<HTML_PAGE_NAME>.html```









